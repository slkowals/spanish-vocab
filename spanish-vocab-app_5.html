<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Vocabulario Espa√±ol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-size: 14px;
            margin: 10px 0;
        }

        .word-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .word-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .word-spanish {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }

        .word-english {
            font-size: 15px;
            color: #555;
            margin-bottom: 8px;
        }

        .word-category {
            display: inline-block;
            background: #e0e7ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .word-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-notebook {
            background: #10b981;
            color: white;
            flex: 1;
        }

        .btn-notebook.added {
            background: #6b7280;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .category-filter {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
        }

        .category-chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            white-space: nowrap;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .category-chip.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .grammar-item {
            background: #fef3c7;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #f59e0b;
        }

        .grammar-title {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
        }

        .grammar-content {
            font-size: 14px;
            color: #78350f;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
                padding-bottom: 80px;
            }

            h1 {
                font-size: 24px;
            }

            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Mi Vocabulario Espa√±ol</h1>
            <div class="subtitle">Learn Spanish on the go</div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('add')">‚ûï Add</button>
            <button class="tab" onclick="switchTab('words')">üìñ Words</button>
            <button class="tab" onclick="switchTab('grammar')">‚úèÔ∏è Grammar</button>
            <button class="tab" onclick="switchTab('backup')">üíæ Backup</button>
        </div>

        <!-- ADD TAB -->
        <div id="addTab" class="tab-content">
            <div class="card">
                <div class="input-group">
                    <label>Spanish Word/Phrase *</label>
                    <input type="text" id="spanishInput" placeholder="e.g., hola, casa, buenos d√≠as">
                </div>

                <div class="input-group">
                    <label>English Translation (optional - auto-translates)</label>
                    <input type="text" id="englishInput" placeholder="Leave blank for auto-translation">
                    <div id="translationPreview" style="margin-top: 8px; padding: 10px; background: #f0f9ff; border-radius: 8px; font-size: 14px; color: #0369a1; display: none;">
                        <span style="font-weight: 600;">Suggested: </span><span id="translationText"></span>
                    </div>
                </div>

                <div class="input-group">
                    <label>Category</label>
                    <select id="categorySelect">
                        <option value="Vocabulary">Vocabulary</option>
                        <option value="Verbs">Verbs</option>
                        <option value="Adjectives">Adjectives</option>
                        <option value="Phrases">Phrases</option>
                        <option value="Food">Food</option>
                        <option value="Travel">Travel</option>
                        <option value="Custom">+ Custom Category</option>
                    </select>
                </div>

                <div class="input-group" id="customCategoryGroup" style="display:none;">
                    <label>Custom Category Name</label>
                    <input type="text" id="customCategoryInput" placeholder="Enter category name">
                </div>

                <div class="input-group">
                    <label>Notes (optional)</label>
                    <textarea id="notesInput" placeholder="Add any additional notes..."></textarea>
                </div>

                <div id="loadingMessage" class="loading" style="display:none;">
                    Translating...
                </div>

                <button class="btn btn-primary" onclick="addWord()">Add Word</button>
            </div>

            <div class="card">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalWords">0</div>
                        <div class="stat-label">Total Words</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="inNotebook">0</div>
                        <div class="stat-label">In Notebook</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="toAdd">0</div>
                        <div class="stat-label">To Add</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WORDS TAB -->
        <div id="wordsTab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="category-filter" id="categoryFilter">
                    <div class="category-chip active" onclick="filterWords('All')">All</div>
                </div>
            </div>

            <div id="wordsList"></div>
        </div>

        <!-- GRAMMAR TAB -->
        <div id="grammarTab" class="tab-content" style="display:none;">
            <div class="card">
                <div class="input-group">
                    <label>Grammar Topic *</label>
                    <input type="text" id="grammarTopic" placeholder="e.g., Present Tense, Ser vs Estar">
                </div>

                <div class="input-group">
                    <label>Notes *</label>
                    <textarea id="grammarNotes" placeholder="Write your grammar notes here..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="addGrammar()">Add Grammar Note</button>
            </div>

            <div id="grammarList"></div>
        </div>

        <!-- BACKUP TAB -->
        <div id="backupTab" class="tab-content" style="display:none;">
            <div class="card">
                <h3 style="margin-bottom: 15px; color: #333;">üíæ Backup Your Data</h3>
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px; line-height: 1.6;">
                    Export your vocabulary and grammar to a file that you can save to iCloud Drive or Files app. 
                    You can import it later if you switch browsers or devices.
                </p>

                <button class="btn btn-primary" onclick="exportData()" style="margin-bottom: 15px;">
                    üì• Export All Data
                </button>

                <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üì§ Restore from Backup</h3>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                        Select a backup file to restore your vocabulary and grammar notes.
                    </p>

                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        üì§ Import Data
                    </button>
                </div>

                <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #ef4444;">‚ö†Ô∏è Clear All Data</h3>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px; line-height: 1.6;">
                        This will permanently delete all your words and grammar notes. Make sure to export first!
                    </p>
                    <button class="btn btn-primary" onclick="clearAllData()" 
                            style="background: #ef4444;">
                        üóëÔ∏è Clear All Data
                    </button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px; color: #333;">üìä Your Data</h3>
                <div style="color: #6b7280; font-size: 14px; line-height: 1.8;">
                    <div><strong>Total Words:</strong> <span id="backupTotalWords">0</span></div>
                    <div><strong>Grammar Notes:</strong> <span id="backupTotalGrammar">0</span></div>
                    <div><strong>Categories:</strong> <span id="backupCategories">0</span></div>
                    <div style="margin-top: 10px; font-size: 12px; color: #9ca3af;">
                        Last backup: <span id="lastBackup">Never</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Word Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Edit Word</div>
            
            <div class="input-group">
                <label>Spanish Word/Phrase *</label>
                <input type="text" id="editSpanish" placeholder="e.g., hola, casa">
            </div>

            <div class="input-group">
                <label>English Translation *</label>
                <input type="text" id="editEnglish" placeholder="e.g., hello, house">
            </div>

            <div class="input-group">
                <label>Category</label>
                <select id="editCategory">
                    <option value="Vocabulary">Vocabulary</option>
                    <option value="Verbs">Verbs</option>
                    <option value="Adjectives">Adjectives</option>
                    <option value="Phrases">Phrases</option>
                    <option value="Food">Food</option>
                    <option value="Travel">Travel</option>
                    <option value="Custom">+ Custom Category</option>
                </select>
            </div>

            <div class="input-group" id="editCustomCategoryGroup" style="display:none;">
                <label>Custom Category Name</label>
                <input type="text" id="editCustomCategory" placeholder="Enter category name">
            </div>

            <div class="input-group">
                <label>Notes (optional)</label>
                <textarea id="editNotes" placeholder="Add any additional notes..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Grammar Modal -->
    <div id="editGrammarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Edit Grammar Note</div>
            
            <div class="input-group">
                <label>Grammar Topic *</label>
                <input type="text" id="editGrammarTopic" placeholder="e.g., Present Tense">
            </div>

            <div class="input-group">
                <label>Notes *</label>
                <textarea id="editGrammarNotes" placeholder="Write your grammar notes here..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditGrammarModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="saveGrammarEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let grammarNotes = [];
        let currentFilter = 'All';
        let editingWordId = null;
        let editingGrammarId = null;

        // Load data from localStorage on startup
        function loadData() {
            const savedWords = localStorage.getItem('spanishWords');
            const savedGrammar = localStorage.getItem('spanishGrammar');
            
            if (savedWords) {
                words = JSON.parse(savedWords);
            }
            if (savedGrammar) {
                grammarNotes = JSON.parse(savedGrammar);
            }
            
            updateStats();
            renderWords();
            renderGrammar();
            updateCategoryFilter();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('spanishWords', JSON.stringify(words));
            localStorage.setItem('spanishGrammar', JSON.stringify(grammarNotes));
        }

        // Debounce function for live translation
        let translationTimeout;
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(translationTimeout);
                translationTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Live translation as user types
        async function liveTranslate(spanishText) {
            const preview = document.getElementById('translationPreview');
            const translationText = document.getElementById('translationText');
            const englishInput = document.getElementById('englishInput');

            // Don't translate if user has already entered something
            if (englishInput.value.trim()) {
                preview.style.display = 'none';
                return;
            }

            // Don't translate if input is too short
            if (!spanishText || spanishText.length < 2) {
                preview.style.display = 'none';
                return;
            }

            try {
                const translation = await autoTranslate(spanishText);
                
                // Only show if English field is still empty
                if (!englishInput.value.trim() && translation) {
                    translationText.textContent = translation;
                    preview.style.display = 'block';
                }
            } catch (error) {
                preview.style.display = 'none';
            }
        }

        // Add event listener for live translation
        document.getElementById('spanishInput').addEventListener('input', debounce(function(e) {
            liveTranslate(e.target.value.trim());
        }, 800));

        // Hide preview when user starts typing in English field
        document.getElementById('englishInput').addEventListener('input', function() {
            if (this.value.trim()) {
                document.getElementById('translationPreview').style.display = 'none';
            }
        });

        // Click to use suggested translation
        document.getElementById('translationPreview').addEventListener('click', function() {
            const suggested = document.getElementById('translationText').textContent;
            document.getElementById('englishInput').value = suggested;
            this.style.display = 'none';
        });

        // Show/hide custom category input
        document.getElementById('categorySelect').addEventListener('change', function() {
            const customGroup = document.getElementById('customCategoryGroup');
            customGroup.style.display = this.value === 'Custom' ? 'block' : 'none';
        });

        // Auto-translate function
        async function autoTranslate(spanishText) {
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(spanishText)}&langpair=es|en`);
                const data = await response.json();
                
                if (data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                }
                return null;
            } catch (error) {
                console.error('Translation error:', error);
                return null;
            }
        }

        // Add word function
        async function addWord() {
            const spanish = document.getElementById('spanishInput').value.trim();
            let english = document.getElementById('englishInput').value.trim();
            const categorySelect = document.getElementById('categorySelect');
            let category = categorySelect.value;
            const notes = document.getElementById('notesInput').value.trim();

            if (!spanish) {
                alert('Please enter a Spanish word or phrase');
                return;
            }

            // Handle custom category
            if (category === 'Custom') {
                const customCategory = document.getElementById('customCategoryInput').value.trim();
                if (!customCategory) {
                    alert('Please enter a custom category name');
                    return;
                }
                category = customCategory;
            }

            // Auto-translate if English not provided
            if (!english) {
                document.getElementById('loadingMessage').style.display = 'block';
                english = await autoTranslate(spanish);
                document.getElementById('loadingMessage').style.display = 'none';
                
                if (!english) {
                    english = '(translation unavailable)';
                }
            }

            // Add word to array
            const word = {
                id: Date.now(),
                spanish,
                english,
                category,
                notes,
                inNotebook: false,
                dateAdded: new Date().toISOString()
            };

            words.unshift(word);
            saveData();

            // Clear form
            document.getElementById('spanishInput').value = '';
            document.getElementById('englishInput').value = '';
            document.getElementById('notesInput').value = '';
            categorySelect.value = 'Vocabulary';
            document.getElementById('customCategoryGroup').style.display = 'none';
            document.getElementById('customCategoryInput').value = '';

            // Update UI
            updateStats();
            updateCategoryFilter();
            renderWords();
        }

        // Toggle notebook status
        function toggleNotebook(id) {
            const word = words.find(w => w.id === id);
            if (word) {
                word.inNotebook = !word.inNotebook;
                saveData();
                updateStats();
                renderWords();
            }
        }

        // Delete word
        function deleteWord(id) {
            if (confirm('Are you sure you want to delete this word?')) {
                words = words.filter(w => w.id !== id);
                saveData();
                updateStats();
                updateCategoryFilter();
                renderWords();
            }
        }

        // Edit word - open modal
        function editWord(id) {
            const word = words.find(w => w.id === id);
            if (!word) return;

            editingWordId = id;

            // Populate form
            document.getElementById('editSpanish').value = word.spanish;
            document.getElementById('editEnglish').value = word.english;
            document.getElementById('editNotes').value = word.notes || '';

            const categorySelect = document.getElementById('editCategory');
            const standardCategories = ['Vocabulary', 'Verbs', 'Adjectives', 'Phrases', 'Food', 'Travel'];
            
            if (standardCategories.includes(word.category)) {
                categorySelect.value = word.category;
                document.getElementById('editCustomCategoryGroup').style.display = 'none';
            } else {
                categorySelect.value = 'Custom';
                document.getElementById('editCustomCategory').value = word.category;
                document.getElementById('editCustomCategoryGroup').style.display = 'block';
            }

            // Show modal
            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingWordId = null;
        }

        // Save edited word
        function saveEdit() {
            const spanish = document.getElementById('editSpanish').value.trim();
            const english = document.getElementById('editEnglish').value.trim();
            const categorySelect = document.getElementById('editCategory');
            let category = categorySelect.value;
            const notes = document.getElementById('editNotes').value.trim();

            if (!spanish || !english) {
                alert('Please fill in both Spanish and English fields');
                return;
            }

            // Handle custom category
            if (category === 'Custom') {
                const customCategory = document.getElementById('editCustomCategory').value.trim();
                if (!customCategory) {
                    alert('Please enter a custom category name');
                    return;
                }
                category = customCategory;
            }

            // Update word
            const word = words.find(w => w.id === editingWordId);
            if (word) {
                word.spanish = spanish;
                word.english = english;
                word.category = category;
                word.notes = notes;
                word.dateModified = new Date().toISOString();

                saveData();
                updateStats();
                updateCategoryFilter();
                renderWords();
                closeEditModal();
            }
        }

        // Handle custom category in edit modal
        document.getElementById('editCategory').addEventListener('change', function() {
            const customGroup = document.getElementById('editCustomCategoryGroup');
            customGroup.style.display = this.value === 'Custom' ? 'block' : 'none';
        });

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Toggle grammar notebook status
        function toggleGrammarNotebook(id) {
            const note = grammarNotes.find(n => n.id === id);
            if (note) {
                note.inNotebook = !note.inNotebook;
                saveData();
                renderGrammar();
            }
        }

        // Edit grammar - open modal
        function editGrammar(id) {
            const note = grammarNotes.find(n => n.id === id);
            if (!note) return;

            editingGrammarId = id;

            // Populate form
            document.getElementById('editGrammarTopic').value = note.topic;
            document.getElementById('editGrammarNotes').value = note.notes;

            // Show modal
            document.getElementById('editGrammarModal').classList.add('active');
        }

        // Close edit grammar modal
        function closeEditGrammarModal() {
            document.getElementById('editGrammarModal').classList.remove('active');
            editingGrammarId = null;
        }

        // Save edited grammar note
        function saveGrammarEdit() {
            const topic = document.getElementById('editGrammarTopic').value.trim();
            const notes = document.getElementById('editGrammarNotes').value.trim();

            if (!topic || !notes) {
                alert('Please fill in both topic and notes');
                return;
            }

            // Update grammar note
            const note = grammarNotes.find(n => n.id === editingGrammarId);
            if (note) {
                note.topic = topic;
                note.notes = notes;
                note.dateModified = new Date().toISOString();

                saveData();
                renderGrammar();
                closeEditGrammarModal();
            }
        }

        // Close grammar modal when clicking outside
        document.getElementById('editGrammarModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditGrammarModal();
            }
        });

        // Render words list
        function renderWords() {
            const container = document.getElementById('wordsList');
            const filteredWords = currentFilter === 'All' 
                ? words 
                : words.filter(w => w.category === currentFilter);

            if (filteredWords.length === 0) {
                container.innerHTML = `
                    <div class="card empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div>No words yet. Start adding vocabulary!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredWords.map(word => `
                <div class="card word-item">
                    <div class="word-header">
                        <div>
                            <div class="word-spanish">${word.spanish}</div>
                            <div class="word-english">${word.english}</div>
                            <span class="word-category">${word.category}</span>
                        </div>
                    </div>
                    ${word.notes ? `<div style="font-size: 13px; color: #6b7280; margin-top: 8px;">${word.notes}</div>` : ''}
                    <div class="word-actions">
                        <button class="btn-small btn-notebook ${word.inNotebook ? 'added' : ''}" 
                                onclick="toggleNotebook(${word.id})">
                            ${word.inNotebook ? '‚úì In Notebook' : '+ Add to Notebook'}
                        </button>
                        <button class="btn-small" style="background: #3b82f6; color: white;" 
                                onclick="editWord(${word.id})">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="deleteWord(${word.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Update category filter
        function updateCategoryFilter() {
            const categories = ['All', ...new Set(words.map(w => w.category))];
            const container = document.getElementById('categoryFilter');
            
            container.innerHTML = categories.map(cat => `
                <div class="category-chip ${cat === currentFilter ? 'active' : ''}" 
                     onclick="filterWords('${cat}')">
                    ${cat}
                </div>
            `).join('');
        }

        // Filter words by category
        function filterWords(category) {
            currentFilter = category;
            updateCategoryFilter();
            renderWords();
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalWords').textContent = words.length;
            document.getElementById('inNotebook').textContent = words.filter(w => w.inNotebook).length;
            document.getElementById('toAdd').textContent = words.filter(w => !w.inNotebook).length;
        }

        // Add grammar note
        function addGrammar() {
            const topic = document.getElementById('grammarTopic').value.trim();
            const notes = document.getElementById('grammarNotes').value.trim();

            if (!topic || !notes) {
                alert('Please fill in both topic and notes');
                return;
            }

            const grammarNote = {
                id: Date.now(),
                topic,
                notes,
                inNotebook: false,
                dateAdded: new Date().toISOString()
            };

            grammarNotes.unshift(grammarNote);
            saveData();

            // Clear form
            document.getElementById('grammarTopic').value = '';
            document.getElementById('grammarNotes').value = '';

            renderGrammar();
        }

        // Delete grammar note
        function deleteGrammar(id) {
            if (confirm('Are you sure you want to delete this grammar note?')) {
                grammarNotes = grammarNotes.filter(g => g.id !== id);
                saveData();
                renderGrammar();
            }
        }

        // Render grammar notes
        function renderGrammar() {
            const container = document.getElementById('grammarList');

            if (grammarNotes.length === 0) {
                container.innerHTML = `
                    <div class="card empty-state">
                        <div class="empty-state-icon">‚úèÔ∏è</div>
                        <div>No grammar notes yet. Start adding!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = grammarNotes.map(note => `
                <div class="grammar-item">
                    <div class="grammar-title">${note.topic}</div>
                    <div class="grammar-content">${note.notes}</div>
                    <div class="word-actions" style="margin-top: 10px;">
                        <button class="btn-small btn-notebook ${note.inNotebook ? 'added' : ''}" 
                                onclick="toggleGrammarNotebook(${note.id})">
                            ${note.inNotebook ? '‚úì In Notebook' : '+ Add to Notebook'}
                        </button>
                        <button class="btn-small" style="background: #3b82f6; color: white;" 
                                onclick="editGrammar(${note.id})">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="deleteGrammar(${note.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            if (tabName === 'add') {
                document.getElementById('addTab').style.display = 'block';
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'words') {
                document.getElementById('wordsTab').style.display = 'block';
                document.querySelectorAll('.tab')[1].classList.add('active');
            } else if (tabName === 'grammar') {
                document.getElementById('grammarTab').style.display = 'block';
                document.querySelectorAll('.tab')[2].classList.add('active');
            } else if (tabName === 'backup') {
                document.getElementById('backupTab').style.display = 'block';
                document.querySelectorAll('.tab')[3].classList.add('active');
                updateBackupStats();
            }
        }

        // Export data to JSON file
        function exportData() {
            const data = {
                words: words,
                grammarNotes: grammarNotes,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `spanish-vocab-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            // Save last backup date
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupStats();

            alert('‚úÖ Backup file downloaded! Save it to your Files app or iCloud Drive.');
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.words || !data.grammarNotes) {
                        alert('‚ùå Invalid backup file format');
                        return;
                    }

                    // Ask for confirmation
                    const confirm = window.confirm(
                        `This backup contains:\n` +
                        `‚Ä¢ ${data.words.length} words\n` +
                        `‚Ä¢ ${data.grammarNotes.length} grammar notes\n\n` +
                        `Do you want to REPLACE your current data or MERGE with it?`
                    );

                    if (confirm === null) return;

                    if (confirm) {
                        // Replace mode
                        words = data.words;
                        grammarNotes = data.grammarNotes;
                    } else {
                        // Merge mode - ask again
                        const doMerge = window.confirm('Click OK to MERGE (add to existing), or Cancel to go back');
                        if (doMerge) {
                            // Merge by adding imported items with new IDs
                            data.words.forEach(word => {
                                words.push({...word, id: Date.now() + Math.random()});
                            });
                            data.grammarNotes.forEach(note => {
                                grammarNotes.push({...note, id: Date.now() + Math.random()});
                            });
                        } else {
                            return;
                        }
                    }

                    saveData();
                    updateStats();
                    updateCategoryFilter();
                    renderWords();
                    renderGrammar();
                    updateBackupStats();

                    alert('‚úÖ Data imported successfully!');
                } catch (error) {
                    alert('‚ùå Error reading backup file. Please make sure it\'s a valid backup file.');
                    console.error(error);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        // Clear all data
        function clearAllData() {
            const confirm1 = window.confirm(
                '‚ö†Ô∏è WARNING: This will delete ALL your words and grammar notes!\n\n' +
                'Have you exported a backup?\n\n' +
                'Click OK to continue with deletion.'
            );

            if (!confirm1) return;

            const confirm2 = window.confirm(
                'üö® FINAL WARNING: Are you absolutely sure?\n\n' +
                'This cannot be undone!'
            );

            if (!confirm2) return;

            words = [];
            grammarNotes = [];
            saveData();
            localStorage.removeItem('lastBackupDate');

            updateStats();
            updateCategoryFilter();
            renderWords();
            renderGrammar();
            updateBackupStats();

            alert('‚úÖ All data has been cleared.');
        }

        // Update backup statistics
        function updateBackupStats() {
            document.getElementById('backupTotalWords').textContent = words.length;
            document.getElementById('backupTotalGrammar').textContent = grammarNotes.length;
            
            const categories = new Set(words.map(w => w.category));
            document.getElementById('backupCategories').textContent = categories.size;

            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                const date = new Date(lastBackup);
                document.getElementById('lastBackup').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            } else {
                document.getElementById('lastBackup').textContent = 'Never';
            }
        }

        // Initialize app
        loadData();
    </script>
</body>
</html>
